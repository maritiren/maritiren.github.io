






<!doctype html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="true"
><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#FFFFFF" />
  
  <title>Trivy in CI Pipeline &middot; Techkroken</title>
    <meta name="title" content="Trivy in CI Pipeline &middot; Techkroken" />
  
  
  
  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.8a082f81b27f3cb2ee528df0b0bdc39787034cf2cc34d4669fbc9977c929023c.js"
    integrity="sha256-iggvgbJ/PLLuUo3wsL3Dl4cDTPLMNNRmn7yZd8kpAjw="
  ></script>
  
  
  
  
  
  
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.b0785c8131a75f72b211435af86269eb2d4b81dda03a8f2cf5ccb1c967747167.css"
    integrity="sha256-sHhcgTGnX3KyEUNa&#43;GJp6y1Lgd2gOo8s9cyxyWd0cWc="
  />
  
  
  
  
    
    
  
  
  
    
    <script
      defer
      type="text/javascript"
      id="script-bundle"
      src="/js/main.bundle.min.d4b727caf411cb5c3b421d0d427ed1e3daeafe0d04840327efad4978430edb8c.js"
      integrity="sha256-1LcnyvQRy1w7Qh0NQn7R49rq/g0EhAMn761JeEMO24w="
      data-copy="Copy"
      data-copied="Copied"
    ></script>
  
  
  <meta
    name="description"
    content="
      
        
      
    "
  />
  
  
  
  <link rel="canonical" href="http://localhost:1313/posts/trivy-pipeline/" />
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="http://localhost:1313/posts/trivy-pipeline/">
  <meta property="og:site_name" content="Techkroken">
  <meta property="og:title" content="Trivy in CI Pipeline">
  <meta property="og:description" content="I realized I needed a place to put my final notes, so here we are^_^">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-10-03T11:42:15+02:00">
    <meta property="article:modified_time" content="2024-10-03T11:42:15+02:00">
    <meta property="article:tag" content="Trivy">
    <meta property="article:tag" content="IaC Scan">
    <meta property="article:tag" content="CI">
    <meta property="article:tag" content="Pipeline">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Trivy in CI Pipeline">
  <meta name="twitter:description" content="I realized I needed a place to put my final notes, so here we are^_^">

  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Blog posts",
    "name": "Trivy in CI Pipeline",
    "headline": "Trivy in CI Pipeline",
    
    
    "inLanguage": "en",
    "url" : "http:\/\/localhost:1313\/posts\/trivy-pipeline\/",
    "author" : {
      "@type": "Person",
      "name": "Marit Iren R. Tokle"
    },
    "copyrightYear": "2024",
    "dateCreated": "2024-10-03T11:42:15\u002b02:00",
    "datePublished": "2024-10-03T11:42:15\u002b02:00",
    
    "dateModified": "2024-10-03T11:42:15\u002b02:00",
    
    "keywords": ["Trivy","IaC scan","CI","pipeline"],
    
    "mainEntityOfPage": "true",
    "wordCount": "760"
  }
  </script>
    
    <script type="application/ld+json">
    {
   "@context": "https://schema.org",
   "@type": "BreadcrumbList",
   "itemListElement": [
     {
       "@type": "ListItem",
       "item": "http://localhost:1313/",
       "name": "Welcome to My Notes! Tada",
       "position": 1
     },
     {
       "@type": "ListItem",
       "item": "http://localhost:1313/posts/",
       "name": "Blog Posts",
       "position": 2
     },
     {
       "@type": "ListItem",
       "name": "Trivy in Ci Pipeline",
       "position": 3
     }
   ]
 }
  </script>

  
  <meta name="author" content="Marit Iren R. Tokle" />
  
    
      <link href="mailto:marit@tokle.dev" rel="me" />
    
      <link href="https://github.com/maritiren" rel="me" />
    
  
  
  






  
  

  
  
</head>
<body
    class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="z-40 flex flex-row items-center">
      
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >Techkroken</a
  >

    </div>
    
      
      <label id="menu-button" for="menu-controller" class="block sm:hidden">
        <input type="checkbox" id="menu-controller" class="hidden" />
        <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
          <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>
</span>
        </div>
        <div
          id="menu-wrapper"
          class="invisible fixed inset-0 z-30 m-auto h-full w-full cursor-default overflow-auto bg-neutral-100/50 opacity-0 backdrop-blur-sm transition-opacity dark:bg-neutral-900/50"
        >
          <ul
            class="mx-auto flex w-full max-w-7xl list-none flex-col overflow-visible px-6 py-6 text-end sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"
          >
            <li class="mb-1">
              <span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"
                ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span></span
              >
            </li>
            
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/posts/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >Blog</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/categories/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >Categories</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/tags/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >Tags</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="https://github.com/maritiren/blog"
                      title=""
                      onclick="close_menu()"
                      target="_blank"
                      >
                        <span
                          class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                        ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    
                    
                  
                </li>
              
                
                  
              
            
          </ul>
        </div>
      </label>
      
      <ul class="hidden list-none flex-row text-end sm:flex">
        
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/posts/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Blog</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/categories/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Categories</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/tags/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Tags</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="https://github.com/maritiren/blog"
                  title=""
                  target="_blank"
                  >
                    <span
                      class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                    ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                
                
              
            </li>
          
            
              
          

        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex grow flex-col">
      <main id="main-content" class="grow">
        
  <article>
    <header class="max-w-prose">
      
      <h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Trivy in CI Pipeline
      </h1>
      
        <div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
          





  
  



  

  
  

  

  

  
    
  

  
    
  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <span title="Reading time">4 mins</span><span class="px-2 text-primary-500">&middot;</span>


  
  

<span class="mb-[2px]">
  <a
    href="https://github.com/maritiren/blog/posts/trivy-ci-pipeline.md"
    class="text-lg hover:text-primary-500"
    rel="noopener noreferrer"
    target="_blank"
    title="Edit content"
    ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M490.3 40.4C512.2 62.27 512.2 97.73 490.3 119.6L460.3 149.7L362.3 51.72L392.4 21.66C414.3-.2135 449.7-.2135 471.6 21.66L490.3 40.4zM172.4 241.7L339.7 74.34L437.7 172.3L270.3 339.6C264.2 345.8 256.7 350.4 248.4 353.2L159.6 382.8C150.1 385.6 141.5 383.4 135 376.1C128.6 370.5 126.4 361 129.2 352.4L158.8 263.6C161.6 255.3 166.2 247.8 172.4 241.7V241.7zM192 63.1C209.7 63.1 224 78.33 224 95.1C224 113.7 209.7 127.1 192 127.1H96C78.33 127.1 64 142.3 64 159.1V416C64 433.7 78.33 448 96 448H352C369.7 448 384 433.7 384 416V319.1C384 302.3 398.3 287.1 416 287.1C433.7 287.1 448 302.3 448 319.1V416C448 469 405 512 352 512H96C42.98 512 0 469 0 416V159.1C0 106.1 42.98 63.1 96 63.1H192z"/></svg>
</span></a
  >
</span>
    

    
    
      <span class="ps-2"><span class="flex">
  <span
    class="ms-1 rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400"
  >
    Draft
  </span>
</span>
</span>
    
  </div>

  
  


        </div>
      
      
    </header>
    <section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row">
      
        <div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8">
          <div class="toc pe-5 lg:sticky lg:top-10 print:hidden">
            <details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5">
  <summary
    class="block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden"
  >
    Table of Contents
  </summary>
  <div class="border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#creating-a-trivy-ci-pipeline">Creating a Trivy CI pipeline</a>
      <ul>
        <li><a href="#gitlab-ci">GitLab CI</a></li>
      </ul>
    </li>
    <li><a href="#debugging">Debugging</a>
      <ul>
        <li><a href="#go-not-scanned-properly">go not scanned properly</a></li>
      </ul>
    </li>
    <li><a href="#resources">Resources</a></li>
  </ul>
</nav>
  </div>
</details>

          </div>
        </div>
      
      <div class="min-h-0 min-w-0 max-w-prose grow">
        <p>I am currently working with automated security testing to get control of the known vulnerabilities in our applications. As part of this, I am scanning a Kubernetes cluster and it&rsquo;s images, as well as application code. We want to cover the whole width, not only application code. Now, we look at a Infrastructure as Code (IaC) scanning tool, <a href="https://trivy.dev/" target="_blank" rel="noreferrer">Trivy</a>.</p>
<p>Read more about Trivy in <a href="http://localhost:1313/posts/trivy/">my other post</a>.</p>
<h2 id="creating-a-trivy-ci-pipeline" class="relative group">Creating a Trivy CI pipeline <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#creating-a-trivy-ci-pipeline" aria-label="Anchor">#</a></span></h2><h3 id="gitlab-ci" class="relative group">GitLab CI <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#gitlab-ci" aria-label="Anchor">#</a></span></h3><p>This pipeline is for GitLab CI when not using GitLab Ultimate.
Ultimate has Trivy included in their scans.
You can read more about it in <a href="https://aquasecurity.github.io/trivy/latest/tutorials/integrations/gitlab-ci/" target="_blank" rel="noreferrer">the Trivy Docs</a>.</p>
<p>The link above contains example pipelines.
Here is another example, using the Trivy container only to do filesystem scan</p>
<div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900">
  <span class="pe-3 text-primary-400">
    <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
</span>
  </span>
  <span class="dark:text-neutral-300">If you want to follow best practice and do both image and filesystem-scan,
you can use <a href="https://aquasecurity.github.io/trivy/v0.56/tutorials/integrations/gitlab-ci/#gitlab-ci-alternative-template" target="_blank" rel="noreferrer">this example</a> from the Trivy docs.</span>
</div>

<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">stages:
</span></span><span class="line"><span class="cl">  - Test
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Trivy IaC scan:
</span></span><span class="line"><span class="cl">  stage: Test
</span></span><span class="line"><span class="cl">  allow_failure: <span class="nb">true</span>  <span class="c1"># show warning, but allow merge for high severity findings</span>
</span></span><span class="line"><span class="cl">  image:
</span></span><span class="line"><span class="cl">    name: docker.io/aquasec/trivy:0.56.2@sha256:26245f364b6f5d223003dc344ec1eb5eb8439052bfecb31d79aeba0c74344b3a
</span></span><span class="line"><span class="cl">    entrypoint: <span class="o">[</span><span class="s2">&#34;&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  variables:
</span></span><span class="line"><span class="cl">    TRIVY_NO_PROGRESS: <span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">    TRIVY_CACHE_DIR: <span class="s2">&#34;.trivycache/&#34;</span>
</span></span><span class="line"><span class="cl">    TRIVY_IGNOREFILE: <span class="s2">&#34;.trivyignore.yaml&#34;</span>
</span></span><span class="line"><span class="cl">  cache:
</span></span><span class="line"><span class="cl">    when: <span class="s1">&#39;always&#39;</span>  <span class="c1"># save cache even when job fails</span>
</span></span><span class="line"><span class="cl">    key: trivy-cache
</span></span><span class="line"><span class="cl">    paths:
</span></span><span class="line"><span class="cl">      - .trivycache
</span></span><span class="line"><span class="cl">  script:
</span></span><span class="line"><span class="cl">    - trivy --version
</span></span><span class="line"><span class="cl">    <span class="c1"># Clear the scan cache (keep the vuln DB)</span>
</span></span><span class="line"><span class="cl">    - trivy clean --scan-cache
</span></span><span class="line"><span class="cl">    <span class="c1"># Build the report</span>
</span></span><span class="line"><span class="cl">    - &gt;
</span></span><span class="line"><span class="cl">      trivy fs . 
</span></span><span class="line"><span class="cl">      --exit-code <span class="m">0</span>
</span></span><span class="line"><span class="cl">      --scanners<span class="o">=</span>misconfig,vuln,secret
</span></span><span class="line"><span class="cl">      --format template
</span></span><span class="line"><span class="cl">      --template <span class="s2">&#34;@/contrib/gitlab-codequality.tpl&#34;</span>
</span></span><span class="line"><span class="cl">      --output trivy_fs_<span class="si">${</span><span class="nv">CI_COMMIT_SHORT_SHA</span><span class="si">}</span>.test.json
</span></span><span class="line"><span class="cl">    <span class="c1"># Fail on HIGH and CRITICAL vulnerabilities</span>
</span></span><span class="line"><span class="cl">    - &gt;
</span></span><span class="line"><span class="cl">      trivy fs . 
</span></span><span class="line"><span class="cl">      --exit-code <span class="m">1</span>
</span></span><span class="line"><span class="cl">      --severity CRITICAL,HIGH
</span></span><span class="line"><span class="cl">  artifacts:
</span></span><span class="line"><span class="cl">    name: <span class="s2">&#34;trivy_fs_</span><span class="si">${</span><span class="nv">CI_COMMIT_SHORT_SHA</span><span class="si">}</span><span class="s2">.test.json&#34;</span>
</span></span><span class="line"><span class="cl">    reports:
</span></span><span class="line"><span class="cl">      codequality: trivy_fs_<span class="si">${</span><span class="nv">CI_COMMIT_SHORT_SHA</span><span class="si">}</span>.test.json
</span></span><span class="line"><span class="cl">    expire_in: <span class="s2">&#34;30 days&#34;</span>
</span></span></code></pre></div><h2 id="debugging" class="relative group">Debugging <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#debugging" aria-label="Anchor">#</a></span></h2><h3 id="go-not-scanned-properly" class="relative group">go not scanned properly <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#go-not-scanned-properly" aria-label="Anchor">#</a></span></h3><p>Some pipelines got 44 findings, while other&rsquo;s had none. By looking at the pipeline logs, we figured that it wasn&rsquo;t detected properly that this was a Go repo.</p>
<p>Running the commands locally also yields no findings (except one that is ignored with .trivyignore). With debug on, I found that Trivy is <code>Skipping vulnerability scan as no version is detected for the package name=&quot;my.project.com/main/module&quot;</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">2024-10-03T11:37:58+02:00	INFO	<span class="o">[</span>gomod<span class="o">]</span> Detecting vulnerabilities...
</span></span><span class="line"><span class="cl">2024-10-03T11:37:58+02:00	DEBUG	<span class="o">[</span>gomod<span class="o">]</span> Scanning packages <span class="k">for</span> vulnerabilities	<span class="nv">file_path</span><span class="o">=</span><span class="s2">&#34;go.mod&#34;</span>
</span></span><span class="line"><span class="cl">2024-10-03T11:37:58+02:00	DEBUG	<span class="o">[</span>gomod<span class="o">]</span> Skipping vulnerability scan as no version is detected <span class="k">for</span> the package <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;my.project.com/main/module&#34;</span>
</span></span></code></pre></div><p>Possibilitites:</p>
<ul>
<li>Set an older version? An idea from <a href="https://github.com/aquasecurity/trivy/discussions/5744" target="_blank" rel="noreferrer">this issue</a> stating it stopped working after version 0.45.1</li>
<li>Maybe the cache isn&rsquo;t working properly</li>
</ul>
<hr>
<p>Trying an older version:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker run -v <span class="nv">$PWD</span>:/src --workdir /src  aquasec/trivy:0.45.0 -d fs . --scanners config,vuln,secret --no-progress
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">2024-10-06T15:12:43.971Z	DEBUG	GOPATH <span class="o">(</span>/root/go/pkg/mod<span class="o">)</span> not found. Need <span class="s1">&#39;go mod download&#39;</span> to fill licenses and dependency relationships
</span></span><span class="line"><span class="cl">2024-10-06T15:12:43.979Z	DEBUG	OS is not detected.
</span></span><span class="line"><span class="cl">2024-10-06T15:12:43.979Z	DEBUG	Detected OS: unknown
</span></span><span class="line"><span class="cl">2024-10-06T15:12:43.979Z	INFO	Number of language-specific files: <span class="m">1</span>
</span></span><span class="line"><span class="cl">2024-10-06T15:12:43.979Z	INFO	Detecting gomod vulnerabilities...
</span></span><span class="line"><span class="cl">2024-10-06T15:12:43.979Z	DEBUG	Detecting library vulnerabilities, type: gomod, path: go.mod
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Dockerfile <span class="o">(</span>dockerfile<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">=======================</span>
</span></span><span class="line"><span class="cl">Tests: <span class="m">26</span> <span class="o">(</span>SUCCESSES: 25, FAILURES: 1, EXCEPTIONS: 0<span class="o">)</span>
</span></span><span class="line"><span class="cl">Failures: <span class="m">1</span> <span class="o">(</span>UNKNOWN: 0, LOW: 1, MEDIUM: 0, HIGH: 0, CRITICAL: 0<span class="o">)</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">.trivycache/policy/content/commands/kubernetes/containerNetworkInterfaceFilePermissions.yaml <span class="o">(</span>secrets<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">======================================================================================================</span>
</span></span><span class="line"><span class="cl">Total: <span class="m">1</span> <span class="o">(</span>UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: 0, CRITICAL: <span class="m">1</span>
</span></span></code></pre></div><p>Trying the newest version at this time, 0.56.0:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker run -v <span class="nv">$PWD</span>:/src --workdir /src  aquasec/trivy:0.56.0 -d fs . --scanners misconfig,vuln,secret --no-progress
</span></span></code></pre></div><hr>
<p>We cloned the Trivy repo and logged to check whether the packages has been scanned. On version 0.56.0, they are scanned even though the main module gets the message <code>Skipping vulnerability scan as no version is detected for the package name=&quot;my.project.com/main/module&quot;</code>. However, when the scan finds all modules, it says <code>Number of language-specific files: N</code>, where N is more than just one.. This needs more investigation.</p>
<p>Found <a href="https://github.com/aquasecurity/trivy/blob/2c87f0cb794acd77446a273582ba1a45b9f18980/pkg/detector/library/detect.go#L32" target="_blank" rel="noreferrer">here</a> in the Trivy code.</p>
<hr>
<p>I think this might be a GitLab Runner issue. Perhaps the GitLab Runner cache. All local tests with and without Trivy cache is working as supposed to. Perhaps not, though. Still looking into it.</p>
<p>The results were inconsistent in GitLab. After clearing the pipeline cache, the pipeline findings are more consistent. However, they are not the same locally and in pipeline. Seems like due to recursive dependencies are added in the pipeline and not locally. Locally, I don&rsquo;t have the
The &ldquo;very&rdquo; old results that had bout 35-44 findings, I think is because of GitLab Runner cache of the Go path.</p>
<p>Regarding the recursive dependencies, I see that the scan fetches packages from <code>$HOME/go/pkg/mod</code>. After running <code>go mod download</code>, I have other dependencies locally than what is scanned in the pipeline. That might cause different results.</p>
<hr>
<p>I decided to try with GitHub Actions to see if it acts weird there as well.</p>
<ul>
<li>The Trivy GH Action uses Trivy version 0.53.0</li>
<li>By default, it doesn&rsquo;t log the output from the Trivy run</li>
</ul>
<hr>
<p>Husk:</p>
<ul>
<li>Sjekk om det er Go cache</li>
<li></li>
</ul>
<h2 id="resources" class="relative group">Resources <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#resources" aria-label="Anchor">#</a></span></h2><ul>
<li><a href="https://www.aquasec.com/blog/devsecops-with-trivy-github-actions/" target="_blank" rel="noreferrer">https://www.aquasec.com/blog/devsecops-with-trivy-github-actions/</a></li>
<li><a href="https://github.com/aquasecurity/trivy/discussions/5744" target="_blank" rel="noreferrer">https://github.com/aquasecurity/trivy/discussions/5744</a></li>
<li>Trivy GitHub discussion: <a href="https://github.com/aquasecurity/trivy/discussions/7585" target="_blank" rel="noreferrer">Intermittent missing vulnerabilities from Trivy 0.55.0 #7585</a></li>
</ul>

      </div>
    </section>
    <footer class="max-w-prose pt-8 print:hidden">
      

      

      
  
    
    
    
      
      
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="group flex" href="/posts/defectdojo/">
              <span
                class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&larr;</span
                ><span class="ltr:hidden rtl:inline">&rarr;</span></span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >DefectDojo with Trivy cluster reports</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="group flex text-right" href="/posts/trivy-operator/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Trivy in Kubernetes</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                </span>
              </span>
              <span
                class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[-2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&rarr;</span
                ><span class="ltr:hidden rtl:inline">&larr;</span></span
              >
            </a>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

      </main>
      
        <div
          class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"
          id="to-top"
          hidden="true"
        >
          <a
            href="#the-top"
            class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
            aria-label="Scroll to top"
            title="Scroll to top"
          >
            &uarr;
          </a>
        </div>
      <footer class="py-10 print:hidden">
  
  
  <div class="flex items-center justify-between">
    <div>
      
      
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
            &copy;
            2024
            Marit Iren R. Tokle
        </p>
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://github.com/jpanther/congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    <div class="flex flex-row items-center">
      
      
      
      
        <div
          class="me-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        >
          <button id="appearance-switcher-0" type="button" aria-label="appearance switcher">
            <div
              class="flex h-12 w-12 items-center justify-center dark:hidden"
              title="Switch to dark appearance"
            >
              <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>
</span>
            </div>
            <div
              class="hidden h-12 w-12 items-center justify-center dark:flex"
              title="Switch to light appearance"
            >
              <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>
</span>
            </div>
          </button>
        </div>
      
    </div>
  </div>
  
  
</footer>

    </div>
  </body>
</html>
